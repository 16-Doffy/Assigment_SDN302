<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Detail - Assigment - SDN302</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/styles.css" rel="stylesheet" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self' http://localhost:5000"
    />
  </head>
  <body>
    <% if (typeof member !== 'undefined' && member) { %> <%-
    include('../partials/header-auth', { member }) %> <% } else { %> <%-
    include('../partials/header-public') %> <% } %>

    <main class="min-h-screen bg-gray-50">
      <div class="container mx-auto px-4 py-8">
        <%- include('../partials/banner', { imageUrl: '/img/nduy6.png', altText:
        'Perfume campaign' }) %>

        <!-- Success Message -->
        <% if (typeof success !== 'undefined' && success) { %>
          <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 rounded">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-3"></i>
              <p class="text-green-700"><%= success %></p>
            </div>
          </div>
        <% } %>

        <!-- Page Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-box mr-3 text-purple-600"></i><%= product.name %>
            </h1>
            <p class="text-gray-600 mt-2 flex items-center">
              <i class="fas fa-info-circle mr-2"></i>Chi tiết sản phẩm
            </p>
          </div>
          <div class="flex space-x-4">
            <a
              href="/products"
              class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors duration-200 flex items-center"
            >
              <i class="fas fa-arrow-left mr-2"></i>Quay lại
            </a>
            <% if (member && member.role === 'admin') { %>
            <a
              href="/products/<%= product._id %>/edit"
              class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg transition-colors duration-200 flex items-center"
            >
              <i class="fas fa-edit mr-2"></i>Chỉnh sửa
            </a>
            <% } %>
          </div>
        </div>

        <!-- Product Details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Product Info -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>Thông tin sản phẩm
              </h3>
              <% if (typeof averageRating !== 'undefined' && averageRating !==
              null) { %>
              <div class="flex items-center space-x-2">
                <div class="flex text-yellow-500">
                  <% const full = Math.round(averageRating || 0); %> <% for (let i = 1; i <= 3; i++) { %>
                  <i class="fas fa-star <%= i <= full ? '' : 'text-gray-300' %>"></i>
                  <% } %>
                </div>
                <span class="text-sm text-gray-600">(<%= ratingCount || 0 %> đánh giá, TB: <%= Math.min(3, Math.max(0, Number(averageRating || 0))).toFixed(1) %>/3)</span>
              </div>
              <% } %>
            </div>

            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Tên sản phẩm</label
                  >
                  <p class="text-lg font-semibold text-gray-800">
                    <%= product.name %>
                  </p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Giá</label>
                  <p class="text-lg font-semibold text-green-600">
                    $<%= product.price.toFixed(2) %>
                  </p>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Thương hiệu</label
                  >
                  <p class="text-lg font-semibold text-gray-800">
                    <%= product.brand || 'Chưa có' %>
                  </p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Danh mục</label
                  >
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-white shadow-sm bg-gradient-to-r <%
                    const cat = product.category || 'General';
                  %><%=
                    cat === 'Citrus' ? 'from-yellow-400 to-orange-500' :
                    cat === 'Floral' ? 'from-pink-400 to-rose-500' :
                    cat === 'Woody' ? 'from-amber-600 to-yellow-700' :
                    cat === 'Fresh' ? 'from-sky-400 to-cyan-500' :
                    cat === 'Oriental' ? 'from-purple-500 to-fuchsia-600' :
                    'from-slate-400 to-gray-500'
                  %>">
                    <%= cat %>
                  </span>
                </div>
</div>

              <div class="grid grid-cols-2 gap-4">
                <% if (product.targetAudience) { %>
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Đối tượng</label
                  >
                  <p class="text-lg font-semibold text-gray-800">
                    <%= product.targetAudience %>
                  </p>
                </div>
                <% } %> <% if (product.extrait) { %>
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Nồng độ (Extrait) </label
                  >
                  <% const ex = (product.extrait || '').toUpperCase(); %>
                  <% const extraitClass =
                    ex === 'PARFUM' || ex === 'EXTRAIT' ? 'from-fuchsia-500 to-rose-600' :
                    ex === 'EDP' ? 'from-rose-400 to-purple-700' :
                    ex === 'EDT' ? 'from-purple-700 to-blue-500' :
                    ex === 'EDC' ? 'from-cyan-500 to-sky-700' :
                    ex === 'EAU FRAICHE' ? 'from-teal-400 to-emerald-500' :
                    'from-slate-400 to-gray-500'; %>
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-white shadow-sm bg-gradient-to-r <%= extraitClass %>">
                    <%= ex || 'N/A' %>
                  </span>
                </div>
<% } %>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Số lượng tồn kho</label
                  >
                  <p class="text-lg font-semibold text-gray-800">
                    <%= product.stock || 0 %>
                  </p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600"
                    >Trạng thái</label
                  >
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold text-white shadow-sm bg-gradient-to-r <%= product.isActive ? 'from-emerald-500 to-teal-500' : 'from-slate-500 to-gray-600' %>">
                    <%= product.isActive ? 'Hoạt động' : 'Tạm dừng' %>
                  </span>
                </div>
              </div>

              <% if (typeof averageRating !== 'undefined' && averageRating !==
              null) { %>
              <div class="mt-2">
                <label class="text-sm font-medium text-gray-600"
                  >Đánh giá trung bình</label
                >
                <div class="flex items-center space-x-2 mt-1">
                  <div class="flex text-yellow-500">
                    <% const full2 = Math.round(averageRating || 0); %> <% for (let i = 1; i <= 3; i++) { %>
                    <i class="fas fa-star <%= i <= full2 ? '' : 'text-gray-300' %>"></i>
                    <% } %>
                  </div>
                  <span class="text-sm text-gray-700"><%= Math.min(3, Math.max(0, Number(averageRating || 0))).toFixed(1) %>/3 từ <%= ratingCount %> đánh giá</span>
                </div>
              </div>
              <% } %> <% if (product.description) { %>
              <div>
                <label class="text-sm font-medium text-gray-600">Mô tả</label>
                <p class="text-gray-800 mt-1"><%= product.description %></p>
              </div>
              <% } %> <% if (product.imageUrl) { %>
              <div>
                <label class="text-sm font-medium text-gray-600"
                  >Hình ảnh</label
                >
                <div class="mt-2">
                  <img
                    src="<%= product.imageUrl %>"
                    alt="<%= product.name %>"
                    class="shadow-lg h-48 w-48 object-cover rounded-lg hover:scale-100 transition-all duration-300"
                  />
                </div>
              </div>
        <% } %>
            </div>
          </div>

          <!-- Feedback Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3
              class="text-xl font-semibold text-gray-800 mb-6 flex items-center"
            >
              <i class="fas fa-comments mr-2"></i>Đánh giá sản phẩm
            </h3>

            <!-- Add Feedback Form: only for user; admin sees nothing, guest sees login note -->
            <% if (!member) { %>
            <div class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-6">
              <p class="text-gray-700">
                <i class="fas fa-info-circle mr-2"></i>Vui lòng đăng nhập để
                đánh giá sản phẩm.
              </p>
            </div>
            <% } else if (member.role === 'user') { %> <% if (!myFeedback) { %>
            <form
              action="/products/<%= product._id %>/feedback"
              method="POST"
              class="mb-6"
            >
              <div class="mb-4">
                <label
                  for="rating"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Đánh giá</label
                >
                <select
                  name="rating"
                  id="rating"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  required
                >
                  <option value="">Chọn đánh giá (1-3)</option>
                  <option value="1">1 - Chưa hài lòng</option>
                  <option value="2">2 - Tạm ổn</option>
                  <option value="3">3 - Hài lòng</option>
      </select>
    </div>
              <div class="mb-4">
                <label
                  for="comment"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Bình luận</label
                >
                <textarea
                  name="comment"
                  id="comment"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  placeholder="Viết đánh giá của bạn..."
                  required
                ></textarea>
    </div>
              <button
                type="submit"
                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200"
              >
                <i class="fas fa-paper-plane mr-2"></i>Gửi đánh giá
              </button>
  </form>
<% } else { %>
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded">
              <div class="flex items-center justify-between mb-3">
                <p class="text-blue-700 flex items-center">
                  <i class="fas fa-info-circle mr-2"></i> Bạn đã đánh giá sản phẩm này.
                </p>
                <div class="flex items-center gap-2">
                  <form method="POST" action="/products/<%= product._id %>/feedback/<%= myFeedback._id %>?_method=DELETE" onsubmit="return confirm('Xóa đánh giá của bạn?');">
                    <input type="hidden" name="_method" value="DELETE" />
                    <button class="inline-flex items-center px-3 py-2 rounded border border-red-300 text-red-600 hover:bg-red-50" type="submit" title="Xóa">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
              <div class="bg-white p-4 rounded-lg border">
                <div class="flex items-center space-x-2 mb-2">
                  <div class="flex text-yellow-500">
                    <% for (let i = 1; i <= 3; i++) { %>
                    <i class="fas fa-star <%= i <= myFeedback.rating ? '' : 'text-gray-300' %>"></i>
<% } %>
                  </div>
                  <span class="text-sm text-gray-500">
                    <%= new Date(myFeedback.createdAt).toLocaleDateString('vi-VN') %>
                  </span>
                </div>
                <p class="text-gray-700"><%= myFeedback.comment %></p>
              </div>
            </div>
            <% } %> <% } %>

            <!-- Feedback List -->
            <div class="space-y-4">
              <% if (feedbacks && feedbacks.length > 0) { %> <%
              feedbacks.forEach(feedback => { %>
              <div
                class="border-l-4 border-purple-400 bg-gray-50 p-4 rounded-r-lg"
              >
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center space-x-2">
                    <span class="font-semibold text-gray-800"
                      ><%= feedback.member.username %></span
                    >
                    <div class="flex text-yellow-500">
                      <% for (let i = 1; i <= 3; i++) { %>
                      <i class="fas fa-star <%= i <= feedback.rating ? '' : 'text-gray-300' %>"></i>
                      <% } %>
                    </div>
                  </div>
                  <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-500"
                      ><%= new
                      Date(feedback.createdAt).toLocaleDateString('vi-VN')
                      %></span
                    >
                    <% if (member && member.role === 'admin') { %>
                    <form
                      method="POST"
                      action="/products/<%= product._id %>/feedback/<%= feedback._id %>?_method=DELETE"
                      onsubmit="return confirm('Admin: Xóa đánh giá này?');"
                      class="inline"
                    >
                      <input type="hidden" name="_method" value="DELETE" />
                      <button
                        class="text-red-600 hover:text-red-800 text-sm"
                        title="Admin: Xóa đánh giá"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                    <% } %>
                  </div>
                </div>
                <p class="text-gray-700"><%= feedback.comment %></p>
              </div>
              <% }) %> <% } else { %>
              <div class="text-center py-8">
                <i class="fas fa-comment-slash text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Chưa có đánh giá nào</p>
              </div>
<% } %>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
